<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®ºæ–‡å†™ä½œé—¯å…³è®° ğŸ®</title>
  <!-- å¤–éƒ¨èµ„æº -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- æ¸¸æˆåŒ–åŠ¨ç”»åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            game: {
              primary: '#6366f1', // æ¸¸æˆç´«
              secondary: '#8b5cf6', // ç´«ç²‰
              success: '#10b981', // æˆå°±ç»¿
              warning: '#f59e0b', // è¿›åº¦æ©™
              danger: '#ef4444', // è­¦ç¤ºçº¢
              dark: '#1e293b',
              light: '#f8fafc'
            },
            badge: {
              bronze: '#cd7f32',
              silver: '#c0c0c0',
              gold: '#ffd700'
            }
          },
          fontFamily: {
            game: ['"Comic Sans MS"', 'Inter', 'sans-serif'],
          },
          boxShadow: {
            'game-card': '0 8px 24px rgba(99, 102, 241, 0.2), 0 2px 8px rgba(0, 0, 0, 0.1)',
            'game-btn': '0 4px 0 rgba(99, 102, 241, 0.5), 0 6px 12px rgba(0, 0, 0, 0.1)',
            'badge': '0 4px 8px rgba(255, 215, 0, 0.3), inset 0 -2px 4px rgba(0, 0, 0, 0.1)'
          }
        }
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      .game-gradient {
        @apply bg-gradient-to-br from-game-primary to-game-secondary;
      }
      .btn-game {
        @apply game-gradient text-white font-bold py-2 px-6 rounded-lg shadow-game-btn 
               hover:translate-y-[-2px] active:translate-y-[1px] transition-all duration-200;
      }
      .card-game {
        @apply bg-white rounded-xl shadow-game-card p-5 transition-all duration-300 
               hover:shadow-lg hover:translate-y-[-4px] border border-purple-100;
      }
      .badge-game {
        @apply inline-flex items-center justify-center w-12 h-12 rounded-full 
               font-bold text-white shadow-badge;
      }
      .progress-game {
        @apply h-6 rounded-full bg-gray-200 overflow-hidden relative;
      }
      .progress-fill {
        @apply h-full rounded-full game-gradient transition-all duration-700 ease-out 
               flex items-center justify-end pr-3 text-white font-bold;
      }
      .level-card {
        @apply card-game border-l-4 border-game-primary cursor-pointer 
               hover:border-game-secondary;
      }
      .achievement-unlocked {
        @apply animate-pulse scale-105;
      }
      .confetti-trigger {
        @apply animate-bounce;
      }
      .shake {
        animation: shake 0.5s ease-in-out;
      }
      @keyframes shake {
        0%, 100% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
      }
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen font-game text-game-dark">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- æ¸¸æˆåŒ–å¤´éƒ¨ -->
    <header class="mb-8 text-center">
      <div class="relative inline-block">
        <h1 class="text-4xl md:text-5xl font-bold game-gradient bg-clip-text text-transparent mb-2">
          è®ºæ–‡å†™ä½œé—¯å…³è®° ğŸ“ğŸ®
        </h1>
        <p class="text-gray-600 text-lg">æŠŠè®ºæ–‡å†™ä½œå˜æˆé—¯å…³æ¸¸æˆï¼Œæ¯å¤©éƒ½æœ‰æ–°æˆå°±ï¼</p>
        <!-- æ¸¸æˆç­‰çº§å¾½ç«  -->
        <div class="absolute -top-4 -right-12 md:-right-20">
          <div class="badge-game bg-badge-gold" id="userLevel">
            Lv.1
          </div>
          <p class="text-xs text-center mt-1 text-gray-600">å†™ä½œç­‰çº§</p>
        </div>
      </div>
    </header>

    <!-- æ ¸å¿ƒæ•°æ®é¢æ¿ï¼ˆæ¸¸æˆåŒ–ç»Ÿè®¡ï¼‰ -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10">
      <!-- æ€»å­—æ•° -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">ğŸ“š æ€»ç›®æ ‡å­—æ•°</h3>
          <i class="fa fa-book text-game-primary text-xl"></i>
        </div>
        <p class="text-4xl font-bold text-game-primary" id="totalWords">0</p>
        <p class="text-sm text-gray-500">æœ¬æ¬¡é—¯å…³æ€»ç›®æ ‡</p>
      </div>
      
      <!-- å·²å†™å­—æ•° -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">âœï¸ å·²å†™å­—æ•°</h3>
          <i class="fa fa-pencil text-game-secondary text-xl"></i>
        </div>
        <p class="text-4xl font-bold text-game-secondary" id="writtenWords">0</p>
        <p class="text-sm text-gray-500">å½“å‰é—¯å…³è¿›åº¦</p>
      </div>
      
      <!-- ä»Šæ—¥æ–°å¢ -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">ğŸ”¥ ä»Šæ—¥æ–°å¢</h3>
          <i class="fa fa-fire text-game-warning text-xl"></i>
        </div>
        <p class="text-4xl font-bold text-game-warning" id="recentWords">0</p>
        <p class="text-sm text-gray-500">ä»Šæ—¥æˆ˜æ–—æˆæœ</p>
      </div>
      
      <!-- å®Œæˆç‡ -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">ğŸ¯ å®Œæˆç‡</h3>
          <i class="fa fa-bullseye text-game-success text-xl"></i>
        </div>
        <p class="text-4xl font-bold text-game-success" id="completionRate">0%</p>
        <div class="progress-game mt-3">
          <div class="progress-fill" id="progressBar" style="width: 0%">0%</div>
        </div>
      </div>
      
      <!-- æˆªæ­¢æ—¥æœŸ -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">â° æˆªæ­¢æ—¥æœŸ</h3>
          <i class="fa fa-clock-o text-game-danger text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-game-danger" id="deadline">æœªè®¾ç½®</p>
        <p class="text-sm font-medium text-gray-600" id="daysLeft">å‰©ä½™æ—¶é—´ï¼š--å¤©</p>
      </div>
      
      <!-- æ¯æ—¥ç›®æ ‡ -->
      <div class="card-game">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-lg font-semibold text-gray-700">ğŸ ä»Šæ—¥ç›®æ ‡</h3>
          <i class="fa fa-gift text-badge-gold text-xl"></i>
        </div>
        <p class="text-2xl font-bold text-badge-gold" id="dailyGoal">0/0 å­—</p>
        <div class="mt-2 text-sm" id="goalTip">
          è®¾å®šæ¯æ—¥ç›®æ ‡ï¼Œè§£é”æˆå°±å¾½ç« ï¼
        </div>
      </div>
    </div>

    <!-- æˆå°±å¢™ & è¿›åº¦å›¾è¡¨ -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-10">
      <!-- æˆå°±å¢™ -->
      <div class="card-game lg:col-span-1">
        <h2 class="text-xl font-bold text-game-primary mb-4 flex items-center">
          <i class="fa fa-trophy mr-2 text-badge-gold"></i> æˆå°±å¢™
        </h2>
        <div class="grid grid-cols-2 gap-4" id="achievementWall">
          <!-- æˆå°±é¡¹ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰ -->
          <div class="bg-gray-100 rounded-lg p-3 text-center opacity-50" id="ach1">
            <div class="badge-game bg-gray-400 mx-auto mb-2">
              <i class="fa fa-pencil"></i>
            </div>
            <p class="text-xs font-medium">é¦–æ¬¡å†™ä½œ</p>
            <p class="text-xs text-gray-500">å†™æ»¡100å­—è§£é”</p>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 text-center opacity-50" id="ach2">
            <div class="badge-game bg-gray-400 mx-auto mb-2">
              <i class="fa fa-calendar"></i>
            </div>
            <p class="text-xs font-medium">æ¯æ—¥æ‰“å¡</p>
            <p class="text-xs text-gray-500">è¿ç»­å†™ä½œ3å¤©è§£é”</p>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 text-center opacity-50" id="ach3">
            <div class="badge-game bg-gray-400 mx-auto mb-2">
              <i class="fa fa-star"></i>
            </div>
            <p class="text-xs font-medium">ç›®æ ‡è¾¾æˆ</p>
            <p class="text-xs text-gray-500">å®Œæˆæ¯æ—¥ç›®æ ‡è§£é”</p>
          </div>
          <div class="bg-gray-100 rounded-lg p-3 text-center opacity-50" id="ach4">
            <div class="badge-game bg-gray-400 mx-auto mb-2">
              <i class="fa fa-flag"></i>
            </div>
            <p class="text-xs font-medium">ç« èŠ‚é€šå…³</p>
            <p class="text-xs text-gray-500">å®Œæˆ1ä¸ªç« èŠ‚è§£é”</p>
          </div>
        </div>
        <button class="w-full mt-4 btn-game py-1 text-sm" id="checkAchievements">
          <i class="fa fa-refresh mr-1"></i> åˆ·æ–°æˆå°±
        </button>
      </div>

      <!-- å†™ä½œè¶‹åŠ¿å›¾è¡¨ -->
      <div class="card-game lg:col-span-2">
        <h2 class="text-xl font-bold text-game-primary mb-4 flex items-center">
          <i class="fa fa-line-chart mr-2"></i> å†™ä½œè¶‹åŠ¿
        </h2>
        <div class="flex space-x-2 mb-4">
          <button class="btn-game py-1 px-4 text-sm active" data-range="day">ä»Šæ—¥</button>
          <button class="bg-gray-200 py-1 px-4 rounded-lg text-sm hover:bg-gray-300 transition" data-range="week">æœ¬å‘¨</button>
          <button class="bg-gray-200 py-1 px-4 rounded-lg text-sm hover:bg-gray-300 transition" data-range="month">æœ¬æœˆ</button>
        </div>
        <div style="height: 250px;">
          <canvas id="trendChart"></canvas>
        </div>
      </div>
    </div>

    <!-- ç« èŠ‚å…³å¡åŒº -->
    <div class="mb-10">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-game-primary flex items-center">
          <i class="fa fa-list-ol mr-2"></i> è®ºæ–‡å…³å¡ï¼ˆç« èŠ‚ï¼‰
        </h2>
        <div class="flex space-x-3">
          <button class="btn-game" id="addChapterBtn">
            <i class="fa fa-plus mr-1"></i> æ–°å¢å…³å¡
          </button>
          <button class="bg-gray-200 py-2 px-6 rounded-lg font-bold hover:bg-gray-300 transition" id="settingsBtn">
            <i class="fa fa-cog mr-1"></i> æ¸¸æˆè®¾ç½®
          </button>
        </div>
      </div>

      <!-- å…³å¡åˆ—è¡¨ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="chapterList">
        <!-- ç©ºçŠ¶æ€ -->
        <div class="col-span-full text-center py-10 text-gray-500">
          <i class="fa fa-gamepad text-5xl mb-3"></i>
          <p class="text-lg">æš‚æ— å…³å¡ï¼Œç‚¹å‡»"æ–°å¢å…³å¡"å¼€å§‹ä½ çš„å†™ä½œé—¯å…³ï¼</p>
        </div>
      </div>
    </div>

    <!-- æ¸¸æˆæç¤ºåŒº -->
    <div class="card-game mb-8">
      <h3 class="text-lg font-bold text-game-primary mb-2 flex items-center">
        <i class="fa fa-lightbulb-o mr-2 text-game-warning"></i> æ¸¸æˆæ”»ç•¥
      </h3>
      <ul class="list-disc list-inside text-gray-700 space-y-1 text-sm">
        <li>æ¯å®Œæˆä¸€ä¸ªç« èŠ‚ = é€šå…³ä¸€ä¸ªå…³å¡ï¼Œè§£é”å¯¹åº”æˆå°±</li>
        <li>æ¯æ—¥è¾¾æˆå†™ä½œç›®æ ‡ï¼Œå¯æå‡å†™ä½œç­‰çº§</li>
        <li>æˆªæ­¢æ—¥æœŸå‰å®Œæˆæ€»ç›®æ ‡ï¼Œè§£é”ç»ˆææˆå°±</li>
        <li>æ‰€æœ‰æ•°æ®è‡ªåŠ¨ä¿å­˜ï¼Œåˆ·æ–°é¡µé¢ä¸ä¼šä¸¢å¤±</li>
        <li>å®Œæˆå…³é”®èŠ‚ç‚¹ä¼šè§¦å‘åº†ç¥ç‰¹æ•ˆå“¦ ğŸ‰</li>
      </ul>
    </div>
  </div>

  <!-- æ–°å¢å…³å¡å¼¹çª— -->
  <div id="addChapterModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
      <h3 class="text-xl font-bold text-game-primary mb-4">æ–°å¢å†™ä½œå…³å¡</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å…³å¡åç§°ï¼ˆç« èŠ‚ï¼‰</label>
        <input type="text" id="chapterName" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" placeholder="ä¾‹å¦‚ï¼šå¼•è¨€ã€æ–‡çŒ®ç»¼è¿°">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å…³å¡ç›®æ ‡å­—æ•°</label>
        <input type="number" id="chapterTarget" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" min="1" placeholder="ä¾‹å¦‚ï¼š2000">
      </div>
      <div class="flex justify-end space-x-3">
        <button class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition" id="cancelAdd">å–æ¶ˆ</button>
        <button class="px-4 py-2 btn-game" id="confirmAdd">åˆ›å»ºå…³å¡</button>
      </div>
    </div>
  </div>

  <!-- ç¼–è¾‘å…³å¡å¼¹çª— -->
  <div id="editChapterModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
      <h3 class="text-xl font-bold text-game-primary mb-4">ç¼–è¾‘å…³å¡è¿›åº¦</h3>
      <input type="hidden" id="editChapterId">
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å…³å¡åç§°</label>
        <input type="text" id="editChapterName" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å…³å¡ç›®æ ‡å­—æ•°</label>
        <input type="number" id="editChapterTarget" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" min="1">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å·²å®Œæˆå­—æ•°</label>
        <input type="number" id="editChapterWritten" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" min="0">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">å…³å¡çŠ¶æ€</label>
        <select id="editChapterStatus" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary">
          <option value="pending">æœªå¼€å§‹</option>
          <option value="progress">è¿›è¡Œä¸­</option>
          <option value="done">å·²é€šå…³</option>
        </select>
      </div>
      <div class="flex justify-end space-x-3">
        <button class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition" id="cancelEdit">å–æ¶ˆ</button>
        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" id="deleteChapter">åˆ é™¤å…³å¡</button>
        <button class="px-4 py-2 btn-game" id="confirmEdit">ä¿å­˜è¿›åº¦</button>
      </div>
    </div>
  </div>

  <!-- æ¸¸æˆè®¾ç½®å¼¹çª— -->
  <div id="settingsModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl p-6 max-w-md w-full shadow-xl">
      <h3 class="text-xl font-bold text-game-primary mb-4">æ¸¸æˆè®¾ç½®</h3>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">è®ºæ–‡æ€»ç›®æ ‡å­—æ•°</label>
        <input type="number" id="totalTarget" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" min="1" placeholder="ä¾‹å¦‚ï¼š10000">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">æ¯æ—¥å†™ä½œç›®æ ‡</label>
        <input type="number" id="dailyTarget" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary" min="1" placeholder="ä¾‹å¦‚ï¼š500">
      </div>
      <div class="mb-4">
        <label class="block text-gray-700 mb-1 text-sm">è®ºæ–‡æˆªæ­¢æ—¥æœŸ</label>
        <input type="date" id="deadlineInput" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-game-primary">
      </div>
      <div class="flex justify-between space-x-3">
        <button class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition" id="resetAll">
          <i class="fa fa-refresh mr-1"></i> é‡ç½®æ‰€æœ‰
        </button>
        <div class="flex space-x-3">
          <button class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 transition" id="cancelSettings">å–æ¶ˆ</button>
          <button class="px-4 py-2 btn-game" id="saveSettings">ä¿å­˜è®¾ç½®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æˆå°±è§£é”å¼¹çª— -->
  <div id="achievementModal" class="fixed bottom-8 right-8 bg-white rounded-xl p-4 shadow-xl z-50 hidden transform transition-all duration-500 translate-y-10 opacity-0">
    <div class="flex items-center">
      <div class="badge-game bg-badge-gold mr-3">
        <i class="fa fa-trophy"></i>
      </div>
      <div>
        <p class="text-sm text-gray-500">æˆå°±è§£é”ï¼</p>
        <p class="font-bold text-game-primary" id="achievementTitle">é¦–æ¬¡å†™ä½œ</p>
      </div>
    </div>
  </div>

  <script>
    // æ ¸å¿ƒæ•°æ®å­˜å‚¨
    const STORAGE_KEY = {
      CHAPTERS: 'thesis_game_chapters',
      SETTINGS: 'thesis_game_settings',
      PROGRESS: 'thesis_game_progress',
      ACHIEVEMENTS: 'thesis_game_achievements'
    };

    // åˆå§‹åŒ–æ•°æ®
    let chapters = JSON.parse(localStorage.getItem(STORAGE_KEY.CHAPTERS)) || [];
    let settings = JSON.parse(localStorage.getItem(STORAGE_KEY.SETTINGS)) || {
      totalTarget: 0,
      dailyTarget: 0,
      deadline: null
    };
    let progress = JSON.parse(localStorage.getItem(STORAGE_KEY.PROGRESS)) || {
      daily: {}, // æ¯æ—¥è¿›åº¦ {date: words}
      totalWritten: 0
    };
    let achievements = JSON.parse(localStorage.getItem(STORAGE_KEY.ACHIEVEMENTS)) || {
      firstWrite: false,    // é¦–æ¬¡å†™ä½œï¼ˆ100å­—ï¼‰
      dailyCheck: false,    // è¿ç»­3å¤©æ‰“å¡
      goalComplete: false,  // å®Œæˆæ¯æ—¥ç›®æ ‡
      chapterDone: false    // å®Œæˆ1ä¸ªç« èŠ‚
    };

    const today = new Date().toISOString().split('T')[0];
    // ç¡®ä¿ä»Šæ—¥è¿›åº¦å­˜åœ¨
    if (!progress.daily[today]) progress.daily[today] = 0;

    // DOM å…ƒç´ 
    const els = {
      totalWords: document.getElementById('totalWords'),
      writtenWords: document.getElementById('writtenWords'),
      recentWords: document.getElementById('recentWords'),
      completionRate: document.getElementById('completionRate'),
      progressBar: document.getElementById('progressBar'),
      deadline: document.getElementById('deadline'),
      daysLeft: document.getElementById('daysLeft'),
      dailyGoal: document.getElementById('dailyGoal'),
      goalTip: document.getElementById('goalTip'),
      userLevel: document.getElementById('userLevel'),
      chapterList: document.getElementById('chapterList'),
      achievementWall: document.getElementById('achievementWall'),
      achievementModal: document.getElementById('achievementModal'),
      achievementTitle: document.getElementById('achievementTitle'),
      
      // å¼¹çª—ç›¸å…³
      addChapterModal: document.getElementById('addChapterModal'),
      editChapterModal: document.getElementById('editChapterModal'),
      settingsModal: document.getElementById('settingsModal'),
      
      // æŒ‰é’®ç›¸å…³
      addChapterBtn: document.getElementById('addChapterBtn'),
      settingsBtn: document.getElementById('settingsBtn'),
      checkAchievements: document.getElementById('checkAchievements')
    };

    // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
    function saveData() {
      localStorage.setItem(STORAGE_KEY.CHAPTERS, JSON.stringify(chapters));
      localStorage.setItem(STORAGE_KEY.SETTINGS, JSON.stringify(settings));
      localStorage.setItem(STORAGE_KEY.PROGRESS, JSON.stringify(progress));
      localStorage.setItem(STORAGE_KEY.ACHIEVEMENTS, JSON.stringify(achievements));
    }

    // æ›´æ–°æ ¸å¿ƒç»Ÿè®¡æ•°æ®
    function updateStats() {
      // è®¡ç®—æ€»å·²å†™å­—æ•°
      const totalWritten = chapters.reduce((sum, chap) => sum + chap.written, 0);
      progress.totalWritten = totalWritten;
      
      // æ›´æ–°DOM
      els.totalWords.textContent = settings.totalTarget.toLocaleString() || '0';
      els.writtenWords.textContent = totalWritten.toLocaleString();
      els.recentWords.textContent = progress.daily[today].toLocaleString();
      
      // å®Œæˆç‡è®¡ç®—
      const completionRate = settings.totalTarget > 0 
        ? Math.round((totalWritten / settings.totalTarget) * 100) 
        : 0;
      els.completionRate.textContent = `${completionRate}%`;
      els.progressBar.style.width = `${completionRate}%`;
      els.progressBar.textContent = `${completionRate}%`;
      
      // æˆªæ­¢æ—¥æœŸå¤„ç†
      if (settings.deadline) {
        const deadlineDate = new Date(settings.deadline);
        const now = new Date();
        const diffTime = deadlineDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        els.deadline.textContent = deadlineDate.toLocaleDateString('zh-CN');
        
        if (diffDays < 0) {
          els.daysLeft.textContent = `å·²é€¾æœŸ ${Math.abs(diffDays)} å¤© âš ï¸`;
          els.daysLeft.classList.add('text-game-danger');
        } else if (diffDays === 0) {
          els.daysLeft.textContent = 'æœ€å1å¤©ï¼ğŸ”¥';
          els.daysLeft.classList.add('text-game-warning');
        } else {
          els.daysLeft.textContent = `å‰©ä½™ ${diffDays} å¤©`;
          els.daysLeft.classList.remove('text-game-danger', 'text-game-warning');
        }
      } else {
        els.deadline.textContent = 'æœªè®¾ç½®';
        els.daysLeft.textContent = 'å‰©ä½™æ—¶é—´ï¼š--å¤©';
      }
      
      // æ¯æ—¥ç›®æ ‡
      if (settings.dailyTarget > 0) {
        const dailyProgress = progress.daily[today] || 0;
        els.dailyGoal.textContent = `${dailyProgress}/${settings.dailyTarget} å­—`;
        
        if (dailyProgress >= settings.dailyTarget) {
          els.goalTip.textContent = 'ğŸ‰ ä»Šæ—¥ç›®æ ‡è¾¾æˆï¼è§£é”æˆå°±ï¼';
          els.goalTip.classList.add('text-badge-gold');
          // è§£é”æ¯æ—¥ç›®æ ‡æˆå°±
          if (!achievements.goalComplete) {
            unlockAchievement('goalComplete', 'æ¯æ—¥ç›®æ ‡è¾¾æˆ');
          }
        } else {
          const remaining = settings.dailyTarget - dailyProgress;
          els.goalTip.textContent = `è¿˜å·® ${remaining} å­—å®Œæˆä»Šæ—¥ç›®æ ‡ï¼`;
          els.goalTip.classList.remove('text-badge-gold');
        }
      } else {
        els.dailyGoal.textContent = '0/0 å­—';
        els.goalTip.textContent = 'è®¾å®šæ¯æ—¥ç›®æ ‡ï¼Œè§£é”æˆå°±å¾½ç« ï¼';
      }
      
      // æ›´æ–°ç”¨æˆ·ç­‰çº§
      const level = Math.min(Math.floor(totalWritten / 1000) + 1, 99);
      els.userLevel.textContent = `Lv.${level}`;
      
      // æ›´æ–°æˆå°±å¢™
      updateAchievementWall();
    }

    // æ›´æ–°æˆå°±å¢™æ˜¾ç¤º
    function updateAchievementWall() {
      const achElements = {
        ach1: document.getElementById('ach1'),
        ach2: document.getElementById('ach2'),
        ach3: document.getElementById('ach3'),
        ach4: document.getElementById('ach4')
      };
      
      // é¦–æ¬¡å†™ä½œæˆå°±
      if (achievements.firstWrite) {
        achElements.ach1.classList.remove('opacity-50', 'bg-gray-100');
        achElements.ach1.classList.add('bg-purple-50', 'achievement-unlocked');
        achElements.ach1.querySelector('.badge-game').classList.remove('bg-gray-400');
        achElements.ach1.querySelector('.badge-game').classList.add('bg-badge-bronze');
      }
      
      // æ¯æ—¥æ‰“å¡æˆå°±
      if (achievements.dailyCheck) {
        achElements.ach2.classList.remove('opacity-50', 'bg-gray-100');
        achElements.ach2.classList.add('bg-purple-50', 'achievement-unlocked');
        achElements.ach2.querySelector('.badge-game').classList.remove('bg-gray-400');
        achElements.ach2.classList.add('bg-badge-silver');
      }
      
      // ç›®æ ‡è¾¾æˆæˆå°±
      if (achievements.goalComplete) {
        achElements.ach3.classList.remove('opacity-50', 'bg-gray-100');
        achElements.ach3.classList.add('bg-purple-50', 'achievement-unlocked');
        achElements.ach3.querySelector('.badge-game').classList.remove('bg-gray-400');
        achElements.ach3.classList.add('bg-badge-gold');
      }
      
      // ç« èŠ‚é€šå…³æˆå°±
      if (achievements.chapterDone) {
        achElements.ach4.classList.remove('opacity-50', 'bg-gray-100');
        achElements.ach4.classList.add('bg-purple-50', 'achievement-unlocked');
        achElements.ach4.querySelector('.badge-game').classList.remove('bg-gray-400');
        achElements.ach4.classList.add('bg-game-success');
      }
    }

    // æ¸²æŸ“ç« èŠ‚åˆ—è¡¨
    function renderChapters() {
      if (chapters.length === 0) {
        els.chapterList.innerHTML = `
          <div class="col-span-full text-center py-10 text-gray-500">
            <i class="fa fa-gamepad text-5xl mb-3"></i>
            <p class="text-lg">æš‚æ— å…³å¡ï¼Œç‚¹å‡»"æ–°å¢å…³å¡"å¼€å§‹ä½ çš„å†™ä½œé—¯å…³ï¼</p>
          </div>
        `;
        return;
      }
      
      els.chapterList.innerHTML = '';
      chapters.forEach((chapter, index) => {
        const completion = chapter.target > 0 ? Math.round((chapter.written / chapter.target) * 100) : 0;
        let statusText = 'æœªå¼€å§‹';
        let statusClass = 'border-l-game-warning';
        let statusIcon = 'fa-hourglass-o';
        
        if (chapter.status === 'progress') {
          statusText = 'è¿›è¡Œä¸­';
          statusClass = 'border-l-game-primary';
          statusIcon = 'fa-spinner fa-spin';
        } else if (chapter.status === 'done') {
          statusText = 'å·²é€šå…³';
          statusClass = 'border-l-game-success';
          statusIcon = 'fa-check';
        }
        
        const chapterCard = `
          <div class="level-card ${statusClass}" data-index="${index}">
            <div class="flex justify-between items-start mb-2">
              <h3 class="font-bold text-lg">${chapter.name}</h3>
              <span class="px-2 py-1 bg-gray-100 rounded-full text-xs font-medium">
                <i class="fa ${statusIcon} mr-1"></i> ${statusText}
              </span>
            </div>
            <div class="mb-3">
              <div class="flex justify-between text-sm mb-1">
                <span>è¿›åº¦</span>
                <span class="font-bold">${chapter.written}/${chapter.target} å­— (${completion}%)</span>
              </div>
              <div class="progress-game h-4">
                <div class="progress-fill h-full rounded-full" style="width: ${completion}%">${completion}%</div>
              </div>
            </div>
            <button class="w-full py-1 bg-gray-200 rounded-lg text-sm hover:bg-gray-300 transition edit-chapter" data-index="${index}">
              <i class="fa fa-pencil mr-1"></i> ç¼–è¾‘è¿›åº¦
            </button>
          </div>
        `;
        
        els.chapterList.insertAdjacentHTML('beforeend', chapterCard);
      });
      
      // ç»‘å®šç« èŠ‚ç¼–è¾‘äº‹ä»¶
      document.querySelectorAll('.edit-chapter').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index || e.target.closest('.edit-chapter').dataset.index);
          openEditChapter(index);
        });
      });
      
      // ç»‘å®šç« èŠ‚å¡ç‰‡ç‚¹å‡»äº‹ä»¶
      document.querySelectorAll('.level-card').forEach(card => {
        card.addEventListener('click', (e) => {
          if (!e.target.closest('.edit-chapter')) {
            const index = parseInt(card.dataset.index);
            openEditChapter(index);
          }
        });
      });
    }

    // è§£é”æˆå°±
    function unlockAchievement(achievementKey, achievementTitle) {
      if (achievements[achievementKey]) return;
      
      // æ›´æ–°æˆå°±çŠ¶æ€
      achievements[achievementKey] = true;
      saveData();
      
      // æ˜¾ç¤ºæˆå°±å¼¹çª—
      els.achievementTitle.textContent = achievementTitle;
      els.achievementModal.classList.remove('hidden', 'translate-y-10', 'opacity-0');
      
      // 3ç§’åéšè—å¼¹çª—
      setTimeout(() => {
        els.achievementModal.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => {
          els.achievementModal.classList.add('hidden');
        }, 500);
      }, 3000);
      
      // è§¦å‘åº†ç¥ç‰¹æ•ˆ
      triggerConfetti();
      
      // æ›´æ–°æˆå°±å¢™
      updateAchievementWall();
    }

    // è§¦å‘åº†ç¥ç‰¹æ•ˆ
    function triggerConfetti() {
      confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.8 },
        colors: ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ffd700']
      });
    }

    // æ£€æŸ¥æˆå°±æ¡ä»¶
    function checkAchievements() {
      const totalWritten = progress.totalWritten;
      
      // æ£€æŸ¥é¦–æ¬¡å†™ä½œæˆå°±ï¼ˆ100å­—ï¼‰
      if (totalWritten >= 100 && !achievements.firstWrite) {
        unlockAchievement('firstWrite', 'é¦–æ¬¡å†™ä½œ');
      }
      
      // æ£€æŸ¥è¿ç»­æ‰“å¡æˆå°±ï¼ˆ3å¤©ï¼‰
      const dates = Object.keys(progress.daily).sort();
      let consecutiveDays = 0;
      let lastDate = null;
      
      dates.forEach(date => {
        if (!lastDate) {
          consecutiveDays = 1;
        } else {
          const d1 = new Date(lastDate);
          const d2 = new Date(date);
          const diff = (d2 - d1) / (1000 * 60 * 60 * 24);
          
          if (diff === 1 && progress.daily[date] > 0) {
            consecutiveDays++;
          } else {
            consecutiveDays = 1;
          }
        }
        lastDate = date;
      });
      
      if (consecutiveDays >= 3 && !achievements.dailyCheck) {
        unlockAchievement('dailyCheck', 'è¿ç»­æ‰“å¡3å¤©');
      }
      
      // æ£€æŸ¥ç« èŠ‚é€šå…³æˆå°±
      const completedChapters = chapters.filter(chap => chap.status === 'done').length;
      if (completedChapters >= 1 && !achievements.chapterDone) {
        unlockAchievement('chapterDone', 'ç« èŠ‚é€šå…³');
      }
      
      updateAchievementWall();
    }

    // æ‰“å¼€æ–°å¢ç« èŠ‚å¼¹çª—
    function openAddChapter() {
      document.getElementById('chapterName').value = '';
      document.getElementById('chapterTarget').value = '';
      els.addChapterModal.classList.remove('hidden');
      document.getElementById('chapterName').focus();
    }

    // å…³é—­æ–°å¢ç« èŠ‚å¼¹çª—
    function closeAddChapter() {
      els.addChapterModal.classList.add('hidden');
    }

    // æ·»åŠ æ–°ç« èŠ‚
    function addChapter() {
      const name = document.getElementById('chapterName').value.trim();
      const target = parseInt(document.getElementById('chapterTarget').value);
      
      if (!name) {
        shakeElement(document.getElementById('chapterName'));
        return alert('è¯·è¾“å…¥å…³å¡åç§°ï¼');
      }
      
      if (isNaN(target) || target < 1) {
        shakeElement(document.getElementById('chapterTarget'));
        return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡å­—æ•°ï¼');
      }
      
      chapters.push({
        id: Date.now(),
        name,
        target,
        written: 0,
        status: 'pending',
        createTime: new Date().toISOString()
      });
      
      saveData();
      renderChapters();
      updateStats();
      closeAddChapter();
      
      // æç¤º
      showToast('å…³å¡åˆ›å»ºæˆåŠŸï¼å¼€å§‹ä½ çš„å†™ä½œé—¯å…³å§ï½');
    }

    // æ‰“å¼€ç¼–è¾‘ç« èŠ‚å¼¹çª—
    function openEditChapter(index) {
      const chapter = chapters[index];
      document.getElementById('editChapterId').value = index;
      document.getElementById('editChapterName').value = chapter.name;
      document.getElementById('editChapterTarget').value = chapter.target;
      document.getElementById('editChapterWritten').value = chapter.written;
      document.getElementById('editChapterStatus').value = chapter.status;
      
      els.editChapterModal.classList.remove('hidden');
    }

    // å…³é—­ç¼–è¾‘ç« èŠ‚å¼¹çª—
    function closeEditChapter() {
      els.editChapterModal.classList.add('hidden');
    }

    // ä¿å­˜ç« èŠ‚ç¼–è¾‘
    function saveChapterEdit() {
      const index = parseInt(document.getElementById('editChapterId').value);
      const name = document.getElementById('editChapterName').value.trim();
      const target = parseInt(document.getElementById('editChapterTarget').value);
      const written = parseInt(document.getElementById('editChapterWritten').value);
      const status = document.getElementById('editChapterStatus').value;
      
      if (!name) {
        shakeElement(document.getElementById('editChapterName'));
        return alert('è¯·è¾“å…¥å…³å¡åç§°ï¼');
      }
      
      if (isNaN(target) || target < 1) {
        shakeElement(document.getElementById('editChapterTarget'));
        return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç›®æ ‡å­—æ•°ï¼');
      }
      
      if (isNaN(written) || written < 0) {
        shakeElement(document.getElementById('editChapterWritten'));
        return alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å·²å®Œæˆå­—æ•°ï¼');
      }
      
      // è®¡ç®—ä»Šæ—¥æ–°å¢å­—æ•°
      const oldWritten = chapters[index].written;
      const newWords = written - oldWritten;
      
      if (newWords > 0) {
        progress.daily[today] = (progress.daily[today] || 0) + newWords;
        progress.totalWritten += newWords;
      }
      
      // æ›´æ–°ç« èŠ‚æ•°æ®
      chapters[index] = {
        ...chapters[index],
        name,
        target,
        written,
        status,
        updateTime: new Date().toISOString()
      };
      
      saveData();
      renderChapters();
      updateStats();
      checkAchievements();
      closeEditChapter();
      
      // è§¦å‘åº†ç¥ç‰¹æ•ˆï¼ˆå¦‚æœå®Œæˆç« èŠ‚ï¼‰
      if (status === 'done' && written >= target) {
        triggerConfetti();
        showToast(`æ­å–œé€šå…³ã€${name}ã€‘å…³å¡ï¼ğŸ‰`);
      } else {
        showToast('è¿›åº¦ä¿å­˜æˆåŠŸï¼ç»§ç»­åŠ æ²¹ï½');
      }
    }

    // åˆ é™¤ç« èŠ‚
    function deleteChapter() {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå…³å¡å—ï¼Ÿåˆ é™¤åæ•°æ®æ— æ³•æ¢å¤ï¼')) return;
      
      const index = parseInt(document.getElementById('editChapterId').value);
      chapters.splice(index, 1);
      
      saveData();
      renderChapters();
      updateStats();
      closeEditChapter();
      
      showToast('å…³å¡å·²åˆ é™¤');
    }

    // æ‰“å¼€è®¾ç½®å¼¹çª—
    function openSettings() {
      document.getElementById('totalTarget').value = settings.totalTarget || '';
      document.getElementById('dailyTarget').value = settings.dailyTarget || '';
      document.getElementById('deadlineInput').value = settings.deadline || '';
      
      els.settingsModal.classList.remove('hidden');
    }

    // å…³é—­è®¾ç½®å¼¹çª—
    function closeSettings() {
      els.settingsModal.classList.add('hidden');
    }

    // ä¿å­˜è®¾ç½®
    function saveSettings() {
      const totalTarget = parseInt(document.getElementById('totalTarget').value);
      const dailyTarget = parseInt(document.getElementById('dailyTarget').value);
      const deadline = document.getElementById('deadlineInput').value;
      
      settings = {
        totalTarget: isNaN(totalTarget) || totalTarget < 1 ? 0 : totalTarget,
        dailyTarget: isNaN(dailyTarget) || dailyTarget < 1 ? 0 : dailyTarget,
        deadline: deadline || null
      };
      
      saveData();
      updateStats();
      closeSettings();
      
      showToast('æ¸¸æˆè®¾ç½®ä¿å­˜æˆåŠŸï¼');
    }

    // é‡ç½®æ‰€æœ‰æ•°æ®
    function resetAllData() {
      if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤æ‰€æœ‰å…³å¡å’Œè¿›åº¦ï¼')) return;
      
      chapters = [];
      settings = { totalTarget: 0, dailyTarget: 0, deadline: null };
      progress = { daily: {}, totalWritten: 0 };
      achievements = { firstWrite: false, dailyCheck: false, goalComplete: false, chapterDone: false };
      
      saveData();
      renderChapters();
      updateStats();
      closeSettings();
      
      showToast('æ‰€æœ‰æ•°æ®å·²é‡ç½®');
    }

    // è¾…åŠ©å‡½æ•°ï¼šéœ‡åŠ¨å…ƒç´ 
    function shakeElement(el) {
      el.classList.add('shake');
      setTimeout(() => el.classList.remove('shake'), 500);
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤ºæç¤º
    function showToast(message) {
      // åˆ›å»ºtoastå…ƒç´ 
      const toast = document.createElement('div');
      toast.className = 'fixed bottom-8 left-8 bg-white rounded-lg px-4 py-2 shadow-lg z-50 transition-all duration-300';
      toast.textContent = message;
      
      document.body.appendChild(toast);
      
      // æ˜¾ç¤ºå¹¶è‡ªåŠ¨éšè—
      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 2000);
    }

    // åˆå§‹åŒ–å›¾è¡¨ï¼ˆç®€åŒ–ç‰ˆè¶‹åŠ¿å›¾ï¼‰
    function initChart() {
      const ctx = document.getElementById('trendChart').getContext('2d');
      
      // å‡†å¤‡è¿‘7å¤©æ•°æ®
      const labels = [];
      const data = [];
      const todayObj = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(todayObj);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        
        labels.push(dateStr.slice(5).replace('-', '/'));
        data.push(progress.daily[dateStr] || 0);
      }
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'æ¯æ—¥å†™ä½œå­—æ•°',
            data,
            borderColor: '#6366f1',
            backgroundColor: 'rgba(99, 102, 241, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
      // æ–°å¢ç« èŠ‚
      els.addChapterBtn.addEventListener('click', openAddChapter);
      document.getElementById('cancelAdd').addEventListener('click', closeAddChapter);
      document.getElementById('confirmAdd').addEventListener('click', addChapter);
      
      // ç¼–è¾‘ç« èŠ‚
      document.getElementById('cancelEdit').addEventListener('click', closeEditChapter);
      document.getElementById('confirmEdit').addEventListener('click', saveChapterEdit);
      document.getElementById('deleteChapter').addEventListener('click', deleteChapter);
      
      // è®¾ç½®
      els.settingsBtn.addEventListener('click', openSettings);
      document.getElementById('cancelSettings').addEventListener('click', closeSettings);
      document.getElementById('saveSettings').addEventListener('click', saveSettings);
      document.getElementById('resetAll').addEventListener('click', resetAllData);
      
      // æˆå°±æ£€æŸ¥
      els.checkAchievements.addEventListener('click', checkAchievements);
      
      // æ—¥æœŸè¾“å…¥é™åˆ¶ï¼ˆä¸èƒ½é€‰è¿‡å»çš„æ—¥æœŸï¼‰
      document.getElementById('deadlineInput').min = today;
      
      // å›è½¦æäº¤
      document.querySelectorAll('input').forEach(input => {
        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            if (els.addChapterModal.classList.contains('hidden') === false) {
              addChapter();
            } else if (els.editChapterModal.classList.contains('hidden') === false) {
              saveChapterEdit();
            } else if (els.settingsModal.classList.contains('hidden') === false) {
              saveSettings();
            }
          }
        });
      });
    }

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      bindEvents();
      renderChapters();
      updateStats();
      checkAchievements();
      initChart();
    }

    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>